<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Education Platform - AI Проверка Работ</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js для реактивности -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Font Awesome для иконок -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Custom styles -->
    <style>
        /* Анимации */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* Градиенты */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Скроллбар */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        /* Загрузка */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Карточки */
        .card-hover {
            transition: all 0.3s;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        /* Progress bar */
        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
    </style>
</head>
<body class="bg-gray-50" x-data="app()" x-init="init()">

    <!-- Навигация -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold gradient-text">
                        <i class="fas fa-graduation-cap"></i> Education Platform
                    </h1>
                </div>

                <div class="flex items-center space-x-6" x-show="user">
                    <!-- Статистика в навбаре -->
                    <div class="hidden md:flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-coins text-yellow-500"></i>
                            <span class="font-semibold" x-text="user?.coins || 0"></span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-star text-purple-500"></i>
                            <span class="font-semibold">Ур. <span x-text="user?.level || 1"></span></span>
                        </div>
                    </div>

                    <!-- Профиль -->
                    <div class="relative" x-data="{ showProfile: false }">
                        <button @click="showProfile = !showProfile"
                                class="flex items-center space-x-2 bg-gray-100 rounded-full px-4 py-2 hover:bg-gray-200 transition">
                            <img src="https://ui-avatars.com/api/?background=667eea&color=fff&name="
                                 :src="'https://ui-avatars.com/api/?background=667eea&color=fff&name=' + (user?.username || 'U')"
                                 class="w-8 h-8 rounded-full">
                            <span x-text="user?.username || 'Гость'"></span>
                            <i class="fas fa-chevron-down text-sm"></i>
                        </button>

                        <div x-show="showProfile" @click.away="showProfile = false"
                             x-transition
                             class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-2">
                            <a href="#" @click="showProfile = false; activeTab = 'profile'"
                               class="block px-4 py-2 hover:bg-gray-100">
                                <i class="fas fa-user mr-2"></i> Профиль
                            </a>
                            <a href="#" @click="showProfile = false; activeTab = 'achievements'"
                               class="block px-4 py-2 hover:bg-gray-100">
                                <i class="fas fa-trophy mr-2"></i> Достижения
                            </a>
                            <a href="#" @click="showProfile = false; activeTab = 'settings'"
                               class="block px-4 py-2 hover:bg-gray-100">
                                <i class="fas fa-cog mr-2"></i> Настройки
                            </a>
                            <hr class="my-2">
                            <a href="#" @click="logout()" class="block px-4 py-2 hover:bg-gray-100 text-red-500">
                                <i class="fas fa-sign-out-alt mr-2"></i> Выйти
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Контент -->
    <div class="container mx-auto px-4 py-8">

        <!-- Экран входа -->
        <div x-show="!user" class="max-w-md mx-auto fade-in">
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <h2 class="text-3xl font-bold text-center mb-8 gradient-text">
                    Добро пожаловать!
                </h2>

                <!-- Табы -->
                <div class="flex space-x-2 mb-6">
                    <button @click="authMode = 'login'"
                            :class="authMode === 'login' ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-700'"
                            class="flex-1 py-2 rounded-lg font-semibold transition">
                        Вход
                    </button>
                    <button @click="authMode = 'register'"
                            :class="authMode === 'register' ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-700'"
                            class="flex-1 py-2 rounded-lg font-semibold transition">
                        Регистрация
                    </button>
                </div>

                <!-- Форма входа -->
                <form @submit.prevent="authMode === 'login' ? login() : register()" class="space-y-4">
                    <div x-show="authMode === 'register'">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" x-model="authData.email"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                               placeholder="email@example.com">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Логин</label>
                        <input type="text" x-model="authData.username"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                               placeholder="Ваш логин">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Пароль</label>
                        <input type="password" x-model="authData.password"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                               placeholder="••••••••">
                    </div>

                    <button type="submit"
                            class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">
                        <span x-text="authMode === 'login' ? 'Войти' : 'Создать аккаунт'"></span>
                    </button>
                </form>

                <!-- Demo вход -->
                <div class="mt-6 text-center">
                    <p class="text-sm text-gray-600">Тестовый вход:</p>
                    <button @click="demoLogin()"
                            class="text-purple-600 hover:text-purple-700 font-semibold">
                        student1 / student123
                    </button>
                </div>

                <!-- Ошибки -->
                <div x-show="authError" class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span x-text="authError"></span>
                </div>
            </div>
        </div>

        <!-- Главный интерфейс -->
        <div x-show="user" class="fade-in">

            <!-- Статистика пользователя -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Монеты</p>
                            <p class="text-3xl font-bold text-yellow-500" x-text="user?.coins || 0"></p>
                        </div>
                        <i class="fas fa-coins text-4xl text-yellow-400 opacity-30"></i>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Уровень</p>
                            <p class="text-3xl font-bold text-purple-500" x-text="user?.level || 1"></p>
                        </div>
                        <i class="fas fa-star text-4xl text-purple-400 opacity-30"></i>
                    </div>
                    <div class="mt-2">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="progress-bar h-2 rounded-full"
                                 :style="'width: ' + ((user?.experience % 100) || 0) + '%'"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Выполнено</p>
                            <p class="text-3xl font-bold text-green-500" x-text="user?.tasks_completed || 0"></p>
                        </div>
                        <i class="fas fa-check-circle text-4xl text-green-400 opacity-30"></i>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Средний балл</p>
                            <p class="text-3xl font-bold text-blue-500">
                                <span x-text="(user?.average_score || 0).toFixed(1)"></span>
                            </p>
                        </div>
                        <i class="fas fa-chart-line text-4xl text-blue-400 opacity-30"></i>
                    </div>
                </div>
            </div>

            <!-- Табы -->
            <div class="bg-white rounded-xl shadow-lg mb-8">
                <div class="flex flex-wrap border-b">
                    <button @click="activeTab = 'tasks'"
                            :class="activeTab === 'tasks' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'"
                            class="px-6 py-4 font-semibold hover:text-purple-600 transition">
                        <i class="fas fa-tasks mr-2"></i> Задания
                    </button>
                    <button @click="activeTab = 'submissions'; loadSubmissions()"
                            :class="activeTab === 'submissions' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'"
                            class="px-6 py-4 font-semibold hover:text-purple-600 transition">
                        <i class="fas fa-paper-plane mr-2"></i> Мои работы
                    </button>
                    <button @click="activeTab = 'shop'; loadShop()"
                            :class="activeTab === 'shop' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'"
                            class="px-6 py-4 font-semibold hover:text-purple-600 transition">
                        <i class="fas fa-shopping-cart mr-2"></i> Магазин
                    </button>
                    <button @click="activeTab = 'leaderboard'; loadLeaderboard()"
                            :class="activeTab === 'leaderboard' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'"
                            class="px-6 py-4 font-semibold hover:text-purple-600 transition">
                        <i class="fas fa-trophy mr-2"></i> Рейтинг
                    </button>
                    <button @click="activeTab = 'achievements'"
                            :class="activeTab === 'achievements' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'"
                            class="px-6 py-4 font-semibold hover:text-purple-600 transition">
                        <i class="fas fa-medal mr-2"></i> Достижения
                    </button>
                </div>

                <div class="p-6">

                    <!-- Задания -->
                    <div x-show="activeTab === 'tasks'" class="fade-in">
                        <div class="mb-6 flex flex-wrap gap-4">
                            <select @change="filterTasks()" x-model="filters.subject"
                                    class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="">Все предметы</option>
                                <option value="Математика">Математика</option>
                                <option value="Физика">Физика</option>
                                <option value="Литература">Литература</option>
                                <option value="Химия">Химия</option>
                            </select>

                            <select @change="filterTasks()" x-model="filters.difficulty"
                                    class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="">Любая сложность</option>
                                <option value="1">⭐ Легко</option>
                                <option value="2">⭐⭐ Средне</option>
                                <option value="3">⭐⭐⭐ Сложно</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <template x-for="task in filteredTasks" :key="task.id">
                                <div class="bg-gray-50 rounded-xl p-6 card-hover cursor-pointer"
                                     @click="selectTask(task)">
                                    <div class="flex justify-between items-start mb-3">
                                        <span class="inline-block px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-semibold"
                                              x-text="task.subject"></span>
                                        <div class="flex items-center">
                                            <template x-for="i in task.difficulty">
                                                <i class="fas fa-star text-yellow-400 text-sm"></i>
                                            </template>
                                        </div>
                                    </div>

                                    <h3 class="text-lg font-bold mb-2" x-text="task.title"></h3>
                                    <p class="text-gray-600 text-sm mb-4 line-clamp-3"
                                       x-text="task.description"></p>

                                    <div class="flex justify-between items-center">
                                        <div class="flex space-x-3">
                                            <span class="text-sm">
                                                <i class="fas fa-coins text-yellow-500"></i>
                                                <span x-text="task.reward_coins"></span>
                                            </span>
                                            <span class="text-sm">
                                                <i class="fas fa-star text-purple-500"></i>
                                                <span x-text="task.reward_exp"></span> XP
                                            </span>
                                        </div>
                                        <button class="gradient-bg text-white px-4 py-2 rounded-lg text-sm font-semibold hover:opacity-90">
                                            Выполнить
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <div x-show="filteredTasks.length === 0" class="text-center py-12">
                            <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">Нет доступных заданий</p>
                        </div>
                    </div>

                    <!-- Мои работы -->
                    <div x-show="activeTab === 'submissions'" class="fade-in">
                        <div class="space-y-4">
                            <template x-for="submission in submissions" :key="submission.id">
                                <div class="bg-gray-50 rounded-xl p-6">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-4 mb-2">
                                                <span class="text-sm text-gray-500">ID: #<span x-text="submission.id"></span></span>
                                                <span :class="{
                                                    'bg-yellow-100 text-yellow-700': submission.status === 'processing',
                                                    'bg-green-100 text-green-700': submission.status === 'checked',
                                                    'bg-red-100 text-red-700': submission.status === 'failed'
                                                }"
                                                      class="px-3 py-1 rounded-full text-sm font-semibold">
                                                    <span x-text="getStatusText(submission.status)"></span>
                                                </span>
                                            </div>

                                            <div x-show="submission.score !== null" class="mb-3">
                                                <div class="flex items-center space-x-4">
                                                    <div class="text-3xl font-bold"
                                                         :class="submission.score >= 80 ? 'text-green-500' : submission.score >= 50 ? 'text-yellow-500' : 'text-red-500'">
                                                        <span x-text="submission.score"></span>/100
                                                    </div>
                                                    <div class="text-sm text-gray-600">
                                                        <i class="fas fa-coins text-yellow-500"></i>
                                                        +<span x-text="submission.coins_earned"></span>
                                                        <span class="ml-2">
                                                            <i class="fas fa-star text-purple-500"></i>
                                                            +<span x-text="submission.exp_earned"></span> XP
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>

                                            <p class="text-gray-700" x-text="submission.ai_feedback"></p>
                                        </div>

                                        <div class="ml-4">
                                            <img :src="submission.photo_url"
                                                 class="w-24 h-24 object-cover rounded-lg cursor-pointer hover:opacity-80"
                                                 @click="showImage(submission.photo_url)">
                                        </div>
                                    </div>

                                    <div class="mt-4 text-sm text-gray-500">
                                        <i class="far fa-clock mr-1"></i>
                                        <span x-text="formatDate(submission.submitted_at)"></span>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <div x-show="submissions.length === 0" class="text-center py-12">
                            <i class="fas fa-folder-open text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">У вас пока нет сданных работ</p>
                        </div>
                    </div>

                    <!-- Магазин -->
                    <div x-show="activeTab === 'shop'" class="fade-in">
                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                            <template x-for="item in shopItems" :key="item.id">
                                <div class="bg-gray-50 rounded-xl p-6 text-center card-hover">
                                    <div class="text-6xl mb-4">
                                        <span x-html="getItemIcon(item)"></span>
                                    </div>
                                    <h3 class="font-bold mb-2" x-text="item.name"></h3>
                                    <p class="text-sm text-gray-600 mb-4" x-text="item.description"></p>
                                    <div class="mb-4">
                                        <span class="text-2xl font-bold text-yellow-500">
                                            <i class="fas fa-coins text-lg"></i>
                                            <span x-text="item.price"></span>
                                        </span>
                                    </div>
                                    <button @click="purchaseItem(item)"
                                            :disabled="user.coins < item.price"
                                            :class="user.coins >= item.price ? 'gradient-bg hover:opacity-90' : 'bg-gray-300 cursor-not-allowed'"
                                            class="w-full text-white py-2 rounded-lg font-semibold transition">
                                        <span x-text="user.coins >= item.price ? 'Купить' : 'Недостаточно монет'"></span>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Рейтинг -->
                    <div x-show="activeTab === 'leaderboard'" class="fade-in">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b">
                                        <th class="text-left py-3 px-4">Место</th>
                                        <th class="text-left py-3 px-4">Пользователь</th>
                                        <th class="text-center py-3 px-4">Уровень</th>
                                        <th class="text-center py-3 px-4">Опыт</th>
                                        <th class="text-center py-3 px-4">Выполнено</th>
                                        <th class="text-center py-3 px-4">Ср. балл</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(entry, index) in leaderboard" :key="index">
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="py-3 px-4">
                                                <span class="text-2xl" x-html="getRankIcon(entry.rank)"></span>
                                            </td>
                                            <td class="py-3 px-4 font-semibold" x-text="entry.username"></td>
                                            <td class="text-center py-3 px-4">
                                                <span class="font-bold text-purple-600" x-text="entry.level"></span>
                                            </td>
                                            <td class="text-center py-3 px-4" x-text="entry.experience"></td>
                                            <td class="text-center py-3 px-4" x-text="entry.tasks_completed"></td>
                                            <td class="text-center py-3 px-4">
                                                <span class="font-semibold" x-text="entry.average_score"></span>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Достижения -->
                    <div x-show="activeTab === 'achievements'" class="fade-in">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                            <div class="text-center">
                                <div class="text-6xl mb-2">🏆</div>
                                <p class="font-semibold">Первая победа</p>
                                <p class="text-sm text-gray-500">Выполните первое задание</p>
                            </div>
                            <div class="text-center opacity-50">
                                <div class="text-6xl mb-2">⭐</div>
                                <p class="font-semibold">Отличник</p>
                                <p class="text-sm text-gray-500">Получите 100 баллов</p>
                            </div>
                            <div class="text-center opacity-50">
                                <div class="text-6xl mb-2">🔥</div>
                                <p class="font-semibold">В ударе</p>
                                <p class="text-sm text-gray-500">7 дней подряд</p>
                            </div>
                            <div class="text-center opacity-50">
                                <div class="text-6xl mb-2">💎</div>
                                <p class="font-semibold">Коллекционер</p>
                                <p class="text-sm text-gray-500">10 покупок в магазине</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <!-- Модальное окно для загрузки фото -->
    <div x-show="selectedTask" @click.away="selectedTask = null"
         x-transition
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" @click.stop>
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-2xl font-bold" x-text="selectedTask?.title"></h2>
                    <button @click="selectedTask = null" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div class="mb-6">
                    <p class="text-gray-700 whitespace-pre-wrap" x-text="selectedTask?.description"></p>
                </div>

                <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center mb-4">
                    <input type="file" id="photoInput" accept="image/*" class="hidden" @change="handleFileSelect">
                    <label for="photoInput" class="cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                        <p class="text-lg font-semibold mb-2">Загрузите фото вашей работы</p>
                        <p class="text-sm text-gray-500">JPG, PNG до 10 МБ</p>
                    </label>

                    <div x-show="selectedFile" class="mt-4">
                        <img :src="previewUrl" class="max-w-full h-64 mx-auto rounded-lg">
                        <p class="mt-2 text-sm text-gray-600" x-text="selectedFile?.name"></p>
                    </div>
                </div>

                <div class="flex justify-end space-x-4">
                    <button @click="selectedTask = null; selectedFile = null"
                            class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
                        Отмена
                    </button>
                    <button @click="submitTask()"
                            :disabled="!selectedFile || submitting"
                            :class="selectedFile && !submitting ? 'gradient-bg hover:opacity-90' : 'bg-gray-300 cursor-not-allowed'"
                            class="px-6 py-2 text-white rounded-lg font-semibold">
                        <span x-show="!submitting">Отправить на проверку</span>
                        <span x-show="submitting">
                            <i class="fas fa-spinner fa-spin mr-2"></i> Отправка...
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Уведомления -->
    <div class="fixed bottom-4 right-4 z-50 space-y-2" id="notifications">
        <!-- Уведомления добавляются динамически -->
    </div>

    <script>
        function app() {
            return {
                // API URL
                apiUrl: window.location.origin + '/api',

                // Состояние
                user: null,
                token: localStorage.getItem('token'),
                authMode: 'login',
                authData: {
                    username: '',
                    email: '',
                    password: ''
                },
                authError: '',

                // UI
                activeTab: 'tasks',
                selectedTask: null,
                selectedFile: null,
                previewUrl: null,
                submitting: false,

                // Данные
                tasks: [],
                filteredTasks: [],
                submissions: [],
                shopItems: [],
                leaderboard: [],

                // Фильтры
                filters: {
                    subject: '',
                    difficulty: ''
                },

                // Инициализация
                async init() {
                    if (this.token) {
                        await this.loadUserData();
                    }
                },

                // Аутентификация
                async login() {
                    this.authError = '';

                    const formData = new FormData();
                    formData.append('username', this.authData.username);
                    formData.append('password', this.authData.password);

                    try {
                        const response = await fetch(`${this.apiUrl}/auth/login`, {
                            method: 'POST',
                            body: formData
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.token = data.access_token;
                            localStorage.setItem('token', this.token);
                            await this.loadUserData();
                            this.showNotification('Вход выполнен успешно!', 'success');
                        } else {
                            // Более детальная обработка ошибок
                            if (response.status === 500) {
                                this.authError = 'Ошибка сервера. Возможно, база данных не настроена. Запустите: python reset_db.py';
                            } else if (response.status === 401) {
                                this.authError = 'Неправильный логин или пароль';
                            } else if (response.status === 423) {
                                this.authError = 'Аккаунт заблокирован';
                            } else {
                                this.authError = data.detail || `Ошибка входа (${response.status})`;
                            }
                            console.error('Login error:', { status: response.status, data });
                        }
                    } catch (error) {
                        console.error('Network error:', error);
                        this.authError = `Ошибка соединения с сервером. Проверьте, что сервер запущен на ${this.apiUrl}`;
                    }
                },

                async register() {
                    this.authError = '';

                    try {
                        const response = await fetch(`${this.apiUrl}/auth/register`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                username: this.authData.username,
                                email: this.authData.email,
                                password: this.authData.password
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.showNotification('Регистрация успешна! Теперь войдите', 'success');
                            this.authMode = 'login';
                            this.authData.email = '';
                            this.authData.password = '';
                        } else {
                            this.authError = data.detail || 'Ошибка регистрации';
                        }
                    } catch (error) {
                        this.authError = 'Ошибка соединения с сервером';
                    }
                },

                async demoLogin() {
                    this.authData.username = 'student1';
                    this.authData.password = 'student123';
                    await this.login();
                },

                logout() {
                    this.token = null;
                    this.user = null;
                    localStorage.removeItem('token');
                    this.showNotification('Вы вышли из системы', 'info');
                },

                // Загрузка данных
                async loadUserData() {
                    try {
                        const response = await fetch(`${this.apiUrl}/auth/me`, {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });

                        if (response.ok) {
                            this.user = await response.json();
                            await this.loadTasks();
                        } else {
                            this.logout();
                        }
                    } catch (error) {
                        console.error('Error loading user data:', error);
                    }
                },

                async loadTasks() {
                    try {
                        const response = await fetch(`${this.apiUrl}/tasks`);
                        this.tasks = await response.json();
                        this.filterTasks();
                    } catch (error) {
                        console.error('Error loading tasks:', error);
                    }
                },

                filterTasks() {
                    this.filteredTasks = this.tasks.filter(task => {
                        if (this.filters.subject && task.subject !== this.filters.subject) return false;
                        if (this.filters.difficulty && task.difficulty != this.filters.difficulty) return false;
                        return true;
                    });
                },

                async loadSubmissions() {
                    try {
                        const response = await fetch(`${this.apiUrl}/submissions/my-submissions`, {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });
                        this.submissions = await response.json();
                    } catch (error) {
                        console.error('Error loading submissions:', error);
                    }
                },

                async loadShop() {
                    try {
                        const response = await fetch(`${this.apiUrl}/shop/items`);
                        this.shopItems = await response.json();
                    } catch (error) {
                        console.error('Error loading shop:', error);
                    }
                },

                async loadLeaderboard() {
                    try {
                        const response = await fetch(`${this.apiUrl}/coins/leaderboard`);
                        this.leaderboard = await response.json();
                    } catch (error) {
                        console.error('Error loading leaderboard:', error);
                    }
                },

                // Работа с заданиями
                selectTask(task) {
                    this.selectedTask = task;
                    this.selectedFile = null;
                    this.previewUrl = null;
                },

                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.selectedFile = file;

                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.previewUrl = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                },

                async submitTask() {
                    if (!this.selectedFile || this.submitting) return;

                    this.submitting = true;

                    const formData = new FormData();
                    formData.append('task_id', this.selectedTask.id);
                    formData.append('photo', this.selectedFile);

                    try {
                        const response = await fetch(`${this.apiUrl}/submissions/submit`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${this.token}` },
                            body: formData
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.showNotification('Работа отправлена на проверку!', 'success');
                            this.selectedTask = null;
                            this.selectedFile = null;

                            // Проверяем статус через некоторое время
                            setTimeout(() => this.checkSubmissionStatus(data.id), 5000);
                        } else {
                            this.showNotification(data.detail || 'Ошибка отправки', 'error');
                        }
                    } catch (error) {
                        this.showNotification('Ошибка соединения', 'error');
                    } finally {
                        this.submitting = false;
                    }
                },

                async checkSubmissionStatus(submissionId) {
                    try {
                        const response = await fetch(`${this.apiUrl}/submissions/${submissionId}/status`, {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });

                        const data = await response.json();

                        if (data.status === 'checked') {
                            this.showNotification(`Проверка завершена! Оценка: ${data.score}/100`, 'success');
                            await this.loadUserData();
                            await this.loadSubmissions();
                        } else if (data.status === 'processing') {
                            // Проверяем еще раз через 5 секунд
                            setTimeout(() => this.checkSubmissionStatus(submissionId), 5000);
                        }
                    } catch (error) {
                        console.error('Error checking status:', error);
                    }
                },

                async purchaseItem(item) {
                    if (this.user.coins < item.price) {
                        this.showNotification('Недостаточно монет!', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/shop/purchase`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${this.token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ item_id: item.id })
                        });

                        if (response.ok) {
                            this.showNotification(`Вы купили "${item.name}"!`, 'success');
                            await this.loadUserData();
                        } else {
                            const data = await response.json();
                            this.showNotification(data.detail || 'Ошибка покупки', 'error');
                        }
                    } catch (error) {
                        this.showNotification('Ошибка соединения', 'error');
                    }
                },

                // Утилиты
                showNotification(message, type = 'info') {
                    const notification = document.createElement('div');
                    notification.className = `p-4 rounded-lg shadow-lg fade-in ${
                        type === 'success' ? 'bg-green-500' :
                        type === 'error' ? 'bg-red-500' :
                        'bg-blue-500'
                    } text-white`;
                    notification.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-${
                                type === 'success' ? 'check-circle' :
                                type === 'error' ? 'exclamation-circle' :
                                'info-circle'
                            } mr-3"></i>
                            <span>${message}</span>
                        </div>
                    `;

                    document.getElementById('notifications').appendChild(notification);

                    setTimeout(() => {
                        notification.style.opacity = '0';
                        setTimeout(() => notification.remove(), 300);
                    }, 3000);
                },

                getStatusText(status) {
                    const statusMap = {
                        'pending': '⏳ Ожидает',
                        'processing': '🔄 Проверяется',
                        'checked': '✅ Проверено',
                        'failed': '❌ Ошибка'
                    };
                    return statusMap[status] || status;
                },

                getItemIcon(item) {
                    const icons = {
                        'avatar': '👤',
                        'badge': '🏅',
                        'theme': '🎨',
                        'power_up': '⚡',
                        'hint': '💡'
                    };
                    return icons[item.item_type] || '📦';
                },

                getRankIcon(rank) {
                    if (rank === 1) return '🥇';
                    if (rank === 2) return '🥈';
                    if (rank === 3) return '🥉';
                    return `#${rank}`;
                },

                formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleString('ru-RU');
                },

                showImage(url) {
                    window.open(url, '_blank');
                }
            }
        }
    </script>

</body>
</html>