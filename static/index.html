<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Education Platform - AI –ü—Ä–æ–≤–µ—Ä–∫–∞ –†–∞–±–æ—Ç</title>

    <!-- Tailwind CSS (self-hosted build) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js –¥–ª—è —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Font Awesome –¥–ª—è –∏–∫–æ–Ω–æ–∫ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Custom styles -->
    <style>
        [x-cloak] { display: none !important; }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card-hover {
            transition: all 0.3s;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        /* Progress bar */
        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

    </style>
</head>
<body class="bg-gray-50" x-data="app()" x-init="init()">

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold gradient-text">
                        <i class="fas fa-graduation-cap"></i> Education Platform
                    </h1>
                </div>

                <div class="flex items-center space-x-6" x-show="isAuthenticated">
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ –Ω–∞–≤–±–∞—Ä–µ -->
                    <div class="hidden md:flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-coins text-yellow-500"></i>
                            <span class="font-semibold" x-text="user?.coins ?? 0"></span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-star text-purple-500"></i>
                            <span class="font-semibold">–£—Ä. <span x-text="user?.level ?? 1"></span></span>
                        </div>
                    </div>

                    <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
                    <div class="relative" x-data="{ showProfile: false }">
                        <button @click="showProfile = !showProfile"
                                class="flex items-center space-x-2 bg-gray-100 rounded-full px-4 py-2 hover:bg-gray-200 transition">
                            <img src="https://ui-avatars.com/api/?background=667eea&color=fff&name="
                                 :src="'https://ui-avatars.com/api/?background=667eea&color=fff&name=' + (user?.username ?? 'U')"
                                 class="w-8 h-8 rounded-full">
                            <span x-text="user?.username ?? '–ì–æ—Å—Ç—å'"></span>
                            <i class="fas fa-chevron-down text-sm"></i>
                        </button>

                        <div x-show="showProfile" @click.away="showProfile = false"
                             x-transition
                             class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-2">
                            <a href="#" @click="showProfile = false; activeTab = 'profile'"
                               class="block px-4 py-2 hover:bg-gray-100">
                                <i class="fas fa-user mr-2"></i> –ü—Ä–æ—Ñ–∏–ª—å
                            </a>
                            <a href="#" @click="showProfile = false; activeTab = 'achievements'"
                               class="block px-4 py-2 hover:bg-gray-100">
                                <i class="fas fa-trophy mr-2"></i> –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
                            </a>
                            <a href="#" @click="showProfile = false; activeTab = 'settings'"
                               class="block px-4 py-2 hover:bg-gray-100">
                                <i class="fas fa-cog mr-2"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                            </a>
                            <hr class="my-2">
                            <a href="#" @click="logout()" class="block px-4 py-2 hover:bg-gray-100 text-red-500">
                                <i class="fas fa-sign-out-alt mr-2"></i> –í—ã–π—Ç–∏
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="container mx-auto px-4 py-8">

        <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
        <div x-show="!isAuthenticated" class="max-w-md mx-auto fade-in">
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <h2 class="text-3xl font-bold text-center mb-8 gradient-text">
                    –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!
                </h2>

                <!-- –¢–∞–±—ã -->
                <div class="flex space-x-2 mb-6">
                    <button @click="authMode = 'login'"
                            :class="authMode === 'login' ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-700'"
                            class="flex-1 py-2 rounded-lg font-semibold transition">
                        –í—Ö–æ–¥
                    </button>
                    <button @click="authMode = 'register'"
                            :class="authMode === 'register' ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-700'"
                            class="flex-1 py-2 rounded-lg font-semibold transition">
                        –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                    </button>
                </div>

                <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
                <form @submit.prevent="authMode === 'login' ? login() : register()" class="space-y-4">
                    <div x-show="authMode === 'register'">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" name="email" autocomplete="email" x-model="authData.email"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                               placeholder="email@example.com">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–õ–æ–≥–∏–Ω</label>
                        <input type="text" name="username" autocomplete="username" x-model="authData.username"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                               placeholder="–í–∞—à –ª–æ–≥–∏–Ω">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" name="password" autocomplete="current-password" x-model="authData.password"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>

                    <button type="submit"
                            class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">
                        <span x-text="authMode === 'login' ? '–í–æ–π—Ç–∏' : '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç'"></span>
                    </button>
                </form>

                <!-- Demo –≤—Ö–æ–¥ -->
                <div class="mt-6 text-center">
                    <p class="text-sm text-gray-600">–¢–µ—Å—Ç–æ–≤—ã–π –≤—Ö–æ–¥:</p>
                    <button @click="demoLogin()"
                            class="text-purple-600 hover:text-purple-700 font-semibold">
                        student1 / student123
                    </button>
                </div>

                <!-- –û—à–∏–±–∫–∏ -->
                <div x-show="authError" class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span x-text="authError"></span>
                </div>
            </div>
        </div>

        <!-- –ì–ª–∞–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
        <div x-show="isAuthenticated" class="fade-in">

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">–ú–æ–Ω–µ—Ç—ã</p>
                            <p class="text-3xl font-bold text-yellow-500" x-text="user?.coins ?? 0"></p>
                        </div>
                        <i class="fas fa-coins text-4xl text-yellow-400 opacity-30"></i>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">–£—Ä–æ–≤–µ–Ω—å</p>
                            <p class="text-3xl font-bold text-purple-500" x-text="user?.level ?? 1"></p>
                        </div>
                        <i class="fas fa-star text-4xl text-purple-400 opacity-30"></i>
                    </div>
                    <div class="mt-2">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="progress-bar h-2 rounded-full"
                                 :style="'width: ' + (Number(user?.experience ?? 0) % 100) + '%'"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</p>
                            <p class="text-3xl font-bold text-green-500" x-text="user?.tasks_completed ?? 0"></p>
                        </div>
                        <i class="fas fa-check-circle text-4xl text-green-400 opacity-30"></i>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</p>
                            <p class="text-3xl font-bold text-blue-500">
                                <span x-text="Number(user?.average_score ?? 0).toFixed(1)"></span>
                            </p>
                        </div>
                        <i class="fas fa-chart-line text-4xl text-blue-400 opacity-30"></i>
                    </div>
                </div>
            </div>

            <!-- –¢–∞–±—ã -->
            <div class="bg-white rounded-xl shadow-lg mb-8">
                <div class="flex flex-wrap border-b">
                    <button @click="activeTab = 'tasks'"
                            :class="activeTab === 'tasks' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'"
                            class="px-6 py-4 font-semibold hover:text-purple-600 transition">
                        <i class="fas fa-tasks mr-2"></i> –ó–∞–¥–∞–Ω–∏—è
                    </button>
                    <button @click="activeTab = 'submissions'; loadSubmissions()"
                            :class="activeTab === 'submissions' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'"
                            class="px-6 py-4 font-semibold hover:text-purple-600 transition">
                        <i class="fas fa-paper-plane mr-2"></i> –ú–æ–∏ —Ä–∞–±–æ—Ç—ã
                    </button>
                    <button @click="activeTab = 'shop'; loadShop()"
                            :class="activeTab === 'shop' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'"
                            class="px-6 py-4 font-semibold hover:text-purple-600 transition">
                        <i class="fas fa-shopping-cart mr-2"></i> –ú–∞–≥–∞–∑–∏–Ω
                    </button>
                    <button @click="activeTab = 'leaderboard'; loadLeaderboard()"
                            :class="activeTab === 'leaderboard' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'"
                            class="px-6 py-4 font-semibold hover:text-purple-600 transition">
                        <i class="fas fa-trophy mr-2"></i> –†–µ–π—Ç–∏–Ω–≥
                    </button>
                    <button @click="activeTab = 'achievements'"
                            :class="activeTab === 'achievements' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'"
                            class="px-6 py-4 font-semibold hover:text-purple-600 transition">
                        <i class="fas fa-medal mr-2"></i> –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
                    </button>
                    <button x-show="isAdmin()"
                            @click="activeTab = 'admin'"
                            :class="activeTab === 'admin' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'"
                            class="px-6 py-4 font-semibold hover:text-purple-600 transition">
                        <i class="fas fa-user-shield mr-2"></i> –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
                    </button>
                </div>

                <div class="p-6">

                    <!-- –ó–∞–¥–∞–Ω–∏—è -->
                    <div x-show="activeTab === 'tasks'" class="fade-in">
                        <div class="mb-6 flex flex-wrap gap-4">
                            <select @change="filterTasks()" x-model="filters.subject"
                                    class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="">–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</option>
                                <option value="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞">–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</option>
                                <option value="–§–∏–∑–∏–∫–∞">–§–∏–∑–∏–∫–∞</option>
                                <option value="–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞">–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞</option>
                                <option value="–•–∏–º–∏—è">–•–∏–º–∏—è</option>
                            </select>

                            <select @change="filterTasks()" x-model="filters.difficulty"
                                    class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="">–õ—é–±–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å</option>
                                <option value="1">‚≠ê –õ–µ–≥–∫–æ</option>
                                <option value="2">‚≠ê‚≠ê –°—Ä–µ–¥–Ω–µ</option>
                                <option value="3">‚≠ê‚≠ê‚≠ê –°–ª–æ–∂–Ω–æ</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <template x-for="task in filteredTasks" :key="task.id">
                                <div class="bg-gray-50 rounded-xl p-6 card-hover cursor-pointer"
                                     @click="selectTask(task)">
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex flex-col gap-2">
                                            <span class="inline-block px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-semibold"
                                                  x-text="task.subject || '–û–±—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ'"></span>
                                            <span x-show="task.isAssigned"
                                                  class="inline-flex items-center px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold uppercase tracking-wide">
                                                <i class="fas fa-user-check mr-1"></i> –ù–∞–∑–Ω–∞—á–µ–Ω–æ –≤–∞–º
                                            </span>
                                        </div>
                                        <div class="flex items-center">
                                            <template x-for="i in task.difficulty">
                                                <i class="fas fa-star text-yellow-400 text-sm"></i>
                                            </template>
                                        </div>
                                    </div>

                                    <h3 class="text-lg font-bold mb-2" x-text="task.title"></h3>
                                    <p class="text-gray-600 text-sm mb-4 line-clamp-3"
                                       x-text="task.description"></p>

                                    <div class="flex justify-between items-center">
                                        <div class="flex space-x-3">
                                            <span class="text-sm">
                                                <i class="fas fa-coins text-yellow-500"></i>
                                                <span x-text="task.reward_coins"></span>
                                            </span>
                                            <span class="text-sm">
                                                <i class="fas fa-star text-purple-500"></i>
                                                <span x-text="task.reward_exp"></span> XP
                                            </span>
                                        </div>
                                        <button class="gradient-bg text-white px-4 py-2 rounded-lg text-sm font-semibold hover:opacity-90">
                                            <span x-text="isAdmin() ? '–ü—Ä–æ—Å–º–æ—Ç—Ä' : '–í—ã–ø–æ–ª–Ω–∏—Ç—å'"></span>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <div x-show="filteredTasks.length === 0" class="text-center py-12">
                            <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</p>
                        </div>
                    </div>

                    <!-- –ú–æ–∏ —Ä–∞–±–æ—Ç—ã -->
                    <div x-show="activeTab === 'submissions'" class="fade-in">
                        <div class="space-y-4">
                            <template x-for="submission in submissions" :key="submission.id">
                                <div class="bg-gray-50 rounded-xl p-6">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-4 mb-2">
                                                <span class="text-sm text-gray-500">ID: #<span x-text="submission.id"></span></span>
                                                <span :class="{
                                                    'bg-yellow-100 text-yellow-700': submission.status === 'processing',
                                                    'bg-green-100 text-green-700': submission.status === 'checked',
                                                    'bg-red-100 text-red-700': submission.status === 'failed'
                                                }"
                                                      class="px-3 py-1 rounded-full text-sm font-semibold">
                                                    <span x-text="getStatusText(submission.status)"></span>
                                                </span>
                                            </div>

                                            <div x-show="submission.score !== null" class="mb-3">
                                                <div class="flex items-center space-x-4">
                                                    <div class="text-3xl font-bold"
                                                         :class="submission.score >= 80 ? 'text-green-500' : submission.score >= 50 ? 'text-yellow-500' : 'text-red-500'">
                                                        <span x-text="submission.score"></span>/100
                                                    </div>
                                                    <div class="text-sm text-gray-600">
                                                        <i class="fas fa-coins text-yellow-500"></i>
                                                        +<span x-text="submission.coins_earned"></span>
                                                        <span class="ml-2">
                                                            <i class="fas fa-star text-purple-500"></i>
                                                            +<span x-text="submission.exp_earned"></span> XP
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>

                                            <p class="text-gray-700" x-text="submission.ai_feedback"></p>
                                        </div>

                                        <div class="ml-4">
                                            <img :src="submission.photo_url"
                                                 class="w-24 h-24 object-cover rounded-lg cursor-pointer hover:opacity-80"
                                                 @click="showImage(submission.photo_url)">
                                        </div>
                                    </div>

                                    <div class="mt-4 text-sm text-gray-500">
                                        <i class="far fa-clock mr-1"></i>
                                        <span x-text="formatDate(submission.submitted_at)"></span>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <div x-show="submissions.length === 0" class="text-center py-12">
                            <i class="fas fa-folder-open text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç</p>
                        </div>
                    </div>

                    <!-- –ú–∞–≥–∞–∑–∏–Ω -->
                    <div x-show="activeTab === 'shop'" class="fade-in">
                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                            <template x-for="item in shopItems" :key="item.id">
                                <div class="bg-gray-50 rounded-xl p-6 text-center card-hover">
                                    <div class="text-6xl mb-4">
                                        <span x-html="getItemIcon(item)"></span>
                                    </div>
                                    <h3 class="font-bold mb-2" x-text="item.name"></h3>
                                    <p class="text-sm text-gray-600 mb-4" x-text="item.description"></p>
                                    <div class="mb-4">
                                        <span class="text-2xl font-bold text-yellow-500">
                                            <i class="fas fa-coins text-lg"></i>
                                            <span x-text="item.price"></span>
                                        </span>
                                    </div>
                                    <button @click="purchaseItem(item)"
                                            :disabled="(user?.coins ?? 0) < item.price"
                                            :class="(user?.coins ?? 0) >= item.price ? 'gradient-bg hover:opacity-90' : 'bg-gray-300 cursor-not-allowed'"
                                            class="w-full text-white py-2 rounded-lg font-semibold transition">
                                        <span x-text="(user?.coins ?? 0) >= item.price ? '–ö—É–ø–∏—Ç—å' : '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç'"></span>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- –†–µ–π—Ç–∏–Ω–≥ -->
                    <div x-show="activeTab === 'leaderboard'" class="fade-in">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b">
                                        <th class="text-left py-3 px-4">–ú–µ—Å—Ç–æ</th>
                                        <th class="text-left py-3 px-4">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                        <th class="text-center py-3 px-4">–£—Ä–æ–≤–µ–Ω—å</th>
                                        <th class="text-center py-3 px-4">–û–ø—ã—Ç</th>
                                        <th class="text-center py-3 px-4">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</th>
                                        <th class="text-center py-3 px-4">–°—Ä. –±–∞–ª–ª</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(entry, index) in leaderboard" :key="index">
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="py-3 px-4">
                                                <span class="text-2xl" x-html="getRankIcon(entry.rank)"></span>
                                            </td>
                                            <td class="py-3 px-4 font-semibold" x-text="entry.username"></td>
                                            <td class="text-center py-3 px-4">
                                                <span class="font-bold text-purple-600" x-text="entry.level"></span>
                                            </td>
                                            <td class="text-center py-3 px-4" x-text="entry.experience"></td>
                                            <td class="text-center py-3 px-4" x-text="entry.tasks_completed"></td>
                                            <td class="text-center py-3 px-4">
                                                <span class="font-semibold" x-text="entry.average_score"></span>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è -->
                    <div x-show="activeTab === 'achievements'" class="fade-in">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                            <div class="text-center">
                                <div class="text-6xl mb-2">üèÜ</div>
                                <p class="font-semibold">–ü–µ—Ä–≤–∞—è –ø–æ–±–µ–¥–∞</p>
                                <p class="text-sm text-gray-500">–í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–µ—Ä–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ</p>
                            </div>
                            <div class="text-center opacity-50">
                                <div class="text-6xl mb-2">‚≠ê</div>
                                <p class="font-semibold">–û—Ç–ª–∏—á–Ω–∏–∫</p>
                                <p class="text-sm text-gray-500">–ü–æ–ª—É—á–∏—Ç–µ 100 –±–∞–ª–ª–æ–≤</p>
                            </div>
                            <div class="text-center opacity-50">
                                <div class="text-6xl mb-2">üî•</div>
                                <p class="font-semibold">–í —É–¥–∞—Ä–µ</p>
                                <p class="text-sm text-gray-500">7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥</p>
                            </div>
                            <div class="text-center opacity-50">
                                <div class="text-6xl mb-2">üíé</div>
                                <p class="font-semibold">–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä</p>
                                <p class="text-sm text-gray-500">10 –ø–æ–∫—É–ø–æ–∫ –≤ –º–∞–≥–∞–∑–∏–Ω–µ</p>
                            </div>
                        </div>
                    </div>

                    <!-- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å -->
                    <div x-show="activeTab === 'admin'" class="fade-in space-y-8" x-cloak>
                        <div class="bg-purple-50 border border-purple-100 rounded-2xl p-6 shadow-inner">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-purple-700">
                                    <i class="fas fa-plus-circle mr-2"></i> –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ
                                </h3>
                                <span class="text-sm text-purple-600" x-text="`–í—ã–±—Ä–∞–Ω–æ —É—á–µ–Ω–∏–∫–æ–≤: ${adminTaskAssignees.length}`"></span>
                            </div>
                            <form @submit.prevent="createAdminTask" class="space-y-6">
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                        <input type="text" x-model="adminTaskForm.title"
                                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ü—Ä–æ–µ–∫—Ç –ø–æ HTML">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">–ü—Ä–µ–¥–º–µ—Ç</label>
                                        <input type="text" x-model="adminTaskForm.subject"
                                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                                               placeholder="–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">–¢–∏–ø –∑–∞–¥–∞–Ω–∏—è</label>
                                        <select x-model="adminTaskForm.task_type"
                                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                                            <option value="math">–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</option>
                                            <option value="essay">–≠—Å—Å–µ</option>
                                            <option value="physics">–§–∏–∑–∏–∫–∞</option>
                                            <option value="chemistry">–•–∏–º–∏—è</option>
                                            <option value="biology">–ë–∏–æ–ª–æ–≥–∏—è</option>
                                            <option value="history">–ò—Å—Ç–æ—Ä–∏—è</option>
                                            <option value="geography">–ì–µ–æ–≥—Ä–∞—Ñ–∏—è</option>
                                            <option value="literature">–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞</option>
                                            <option value="code">–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ</option>
                                            <option value="art">–ò—Å–∫—É—Å—Å—Ç–≤–æ</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                                        <select x-model="adminTaskForm.difficulty"
                                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                                            <option value="1">‚≠ê –õ–µ–≥–∫–æ</option>
                                            <option value="2">‚≠ê‚≠ê –°—Ä–µ–¥–Ω–µ</option>
                                            <option value="3">‚≠ê‚≠ê‚≠ê –°–ª–æ–∂–Ω–æ</option>
                                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê –û—á–µ–Ω—å —Å–ª–æ–∂–Ω–æ</option>
                                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê –≠–∫—Å–ø–µ—Ä—Ç</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">–ù–∞–≥—Ä–∞–¥–∞ (–º–æ–Ω–µ—Ç—ã)</label>
                                        <input type="number" min="0" x-model.number="adminTaskForm.reward_coins"
                                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">–ù–∞–≥—Ä–∞–¥–∞ (–æ–ø—ã—Ç)</label>
                                        <input type="number" min="0" x-model.number="adminTaskForm.reward_exp"
                                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å</label>
                                        <input type="number" min="1" x-model.number="adminTaskForm.min_level"
                                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">–ú–∞–∫—Å. –ø–æ–ø—ã—Ç–æ–∫</label>
                                        <input type="number" min="1" x-model.number="adminTaskForm.max_attempts"
                                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">–í—Ä–µ–º—è (–º–∏–Ω—É—Ç—ã, –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                                        <input type="number" min="0" x-model.number="adminTaskForm.time_limit"
                                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                                               placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</label>
                                    <textarea x-model="adminTaskForm.description" rows="3" minlength="10"
                                              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                                              placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å (–Ω–µ –º–µ–Ω–µ–µ 10 —Å–∏–º–≤–æ–ª–æ–≤)"></textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">HTML –∫–æ–Ω—Ç–µ–Ω—Ç</label>
                                    <textarea x-model="adminTaskForm.content_html" rows="6"
                                              class="w-full font-mono px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                                              placeholder="<h2>–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ</h2>"></textarea>
                                    <p class="text-xs text-gray-500 mt-2">–í—Å—Ç–∞–≤—å—Ç–µ –≥–æ—Ç–æ–≤—ã–π HTML, –∫–æ—Ç–æ—Ä—ã–π —É–≤–∏–¥–∏—Ç —É—á–µ–Ω–∏–∫. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Å—Ç–∏–ª–∏ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.</p>
                                </div>

                                <div class="grid md:grid-cols-2 gap-4">
                                    <div class="bg-white rounded-xl border border-purple-100 p-4">
                                        <h4 class="font-semibold text-gray-700 mb-3">–ü–æ–∏—Å–∫ —É—á–µ–Ω–∏–∫–æ–≤</h4>
                                        <div class="flex gap-2 mb-3">
                                            <input type="text" x-model="adminSearchQueryCreate"
                                                   class="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                                                   placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ email">
                                            <button type="button"
                                                    @click="searchUsers('create')"
                                                    class="px-4 py-2 gradient-bg text-white rounded-lg font-semibold hover:opacity-90">
                                                <span x-show="!adminSearchLoadingCreate">–ù–∞–π—Ç–∏</span>
                                                <span x-show="adminSearchLoadingCreate"><i class="fas fa-spinner fa-spin"></i></span>
                                            </button>
                                        </div>
                                        <div x-show="adminSearchResultsCreate.length" class="space-y-2 max-h-40 overflow-y-auto pr-1">
                                            <template x-for="user in adminSearchResultsCreate" :key="`create-result-${user.id}`">
                                                <div class="flex items-center justify-between bg-purple-50 border border-purple-100 rounded-lg px-3 py-2">
                                                    <div>
                                                        <p class="font-semibold text-gray-700" x-text="user.username"></p>
                                                        <p class="text-xs text-gray-500" x-text="user.email"></p>
                                                    </div>
                                                    <button type="button" class="text-sm text-purple-600 font-semibold hover:underline"
                                                            @click="addAssignee(user, 'create')">
                                                        –î–æ–±–∞–≤–∏—Ç—å
                                                    </button>
                                                </div>
                                            </template>
                                        </div>
                                        <p x-show="!adminSearchResultsCreate.length && !adminSearchLoadingCreate" class="text-sm text-gray-500">–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–∞–π—Ç–∏¬ª, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–æ–≤.</p>
                                    </div>
                                    <div class="bg-white rounded-xl border border-purple-100 p-4">
                                        <h4 class="font-semibold text-gray-700 mb-3">–í—ã–±—Ä–∞–Ω–Ω—ã–µ —É—á–µ–Ω–∏–∫–∏</h4>
                                        <div x-show="adminTaskAssignees.length" class="flex flex-wrap gap-2">
                                            <template x-for="user in adminTaskAssignees" :key="`create-${user.id}`">
                                                <span class="px-3 py-1 bg-purple-600 text-white rounded-full text-sm flex items-center gap-2">
                                                    <span x-text="user.username"></span>
                                                    <button type="button" class="text-white hover:text-purple-100"
                                                            @click="removeAssignee(user.id, 'create')">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </span>
                                            </template>
                                        </div>
                                        <p x-show="!adminTaskAssignees.length" class="text-sm text-gray-500">–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–ª–∏.</p>
                                    </div>
                                </div>

                                <div class="flex justify-end">
                                    <button type="submit"
                                            :disabled="adminCreating"
                                            :class="adminCreating ? 'bg-gray-300 cursor-not-allowed' : 'gradient-bg hover:opacity-90'"
                                            class="px-6 py-3 text-white font-semibold rounded-xl transition">
                                        <span x-show="!adminCreating"><i class="fas fa-save mr-2"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</span>
                                        <span x-show="adminCreating"><i class="fas fa-spinner fa-spin mr-2"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</span>
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="bg-white border border-purple-100 rounded-2xl p-6 shadow-sm">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">
                                <i class="fas fa-user-plus mr-2 text-purple-500"></i> –ù–∞–∑–Ω–∞—á–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ</label>
                                    <select x-model="adminAssignTaskId"
                                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                                        <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ ‚Äî</option>
                                        <template x-for="task in tasks" :key="`assign-task-${task.id}`">
                                            <option :value="task.id" x-text="task.title"></option>
                                        </template>
                                    </select>
                                </div>

                                <div class="grid md:grid-cols-2 gap-4">
                                    <div class="bg-purple-50 rounded-xl border border-purple-100 p-4">
                                        <h4 class="font-semibold text-gray-700 mb-3">–ü–æ–∏—Å–∫ —É—á–µ–Ω–∏–∫–æ–≤</h4>
                                        <div class="flex gap-2 mb-3">
                                            <input type="text" x-model="adminSearchQueryAssign"
                                                   @keydown.enter.prevent="searchUsers('assign')"
                                                   class="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                                                   placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ email">
                                            <button type="button"
                                                    @click="searchUsers('assign')"
                                                    class="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition">
                                                <span x-show="!adminSearchLoadingAssign">–ù–∞–π—Ç–∏</span>
                                                <span x-show="adminSearchLoadingAssign"><i class="fas fa-spinner fa-spin"></i></span>
                                            </button>
                                        </div>
                                        <div x-show="adminSearchResultsAssign.length" class="space-y-2 max-h-40 overflow-y-auto pr-1">
                                            <template x-for="user in adminSearchResultsAssign" :key="`assign-result-${user.id}`">
                                                <div class="flex items-center justify-between bg-white border border-purple-100 rounded-lg px-3 py-2">
                                                    <div>
                                                        <p class="font-semibold text-gray-700" x-text="user.username"></p>
                                                        <p class="text-xs text-gray-500" x-text="user.email"></p>
                                                    </div>
                                                    <button type="button" class="text-sm text-purple-600 font-semibold hover:underline"
                                                            @click="addAssignee(user, 'assign')">
                                                        –î–æ–±–∞–≤–∏—Ç—å
                                                    </button>
                                                </div>
                                            </template>
                                        </div>
                                        <p x-show="!adminSearchResultsAssign.length && !adminSearchLoadingAssign" class="text-sm text-gray-500">–ù–∞–π–¥–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞ –∏ –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è.</p>
                                    </div>
                                    <div class="bg-purple-50 rounded-xl border border-purple-100 p-4">
                                        <h4 class="font-semibold text-gray-700 mb-3">–í—ã–±—Ä–∞–Ω–Ω—ã–µ —É—á–µ–Ω–∏–∫–∏</h4>
                                        <div x-show="adminAssignAssignees.length" class="flex flex-wrap gap-2">
                                            <template x-for="user in adminAssignAssignees" :key="`assign-${user.id}`">
                                                <span class="px-3 py-1 bg-purple-600 text-white rounded-full text-sm flex items-center gap-2">
                                                    <span x-text="user.username"></span>
                                                    <button type="button" class="text-white hover:text-purple-100"
                                                            @click="removeAssignee(user.id, 'assign')">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </span>
                                            </template>
                                        </div>
                                        <p x-show="!adminAssignAssignees.length" class="text-sm text-gray-500">–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–ª–∏.</p>
                                    </div>
                                </div>

                                <div class="flex justify-end">
                                    <button type="button"
                                            @click="assignExistingTask()"
                                            :disabled="adminAssigning"
                                            :class="adminAssigning ? 'bg-gray-300 cursor-not-allowed' : 'bg-purple-600 hover:bg-purple-700'"
                                            class="px-6 py-3 text-white font-semibold rounded-xl transition">
                                        <span x-show="!adminAssigning"><i class="fas fa-paper-plane mr-2"></i> –ù–∞–∑–Ω–∞—á–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–º</span>
                                        <span x-show="adminAssigning"><i class="fas fa-spinner fa-spin mr-2"></i> –ù–∞–∑–Ω–∞—á–∞–µ–º...</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white border border-purple-100 rounded-2xl p-6 shadow-sm">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">
                                        <i class="fas fa-layer-group mr-2 text-purple-500"></i> –°–æ–∑–¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è
                                    </h3>
                                    <p class="text-sm text-gray-500"
                                       x-text="adminTasksTotal ? ('–í—Å–µ–≥–æ ' + adminTasksTotal + ' –∑–∞–¥–∞–Ω–∏–π') : '–ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –∑–∞–¥–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã —Å–æ–∑–¥–∞–¥–∏—Ç–µ.'"></p>
                                </div>
                                <button type="button"
                                        @click="loadTasks()"
                                        :disabled="adminTasksLoading"
                                        class="inline-flex items-center justify-center px-4 py-2 rounded-lg font-semibold border border-purple-200 text-purple-600 hover:bg-purple-50 disabled:opacity-60 disabled:cursor-not-allowed">
                                    <i class="fas fa-rotate mr-2" :class="adminTasksLoading ? 'fa-spin' : ''"></i>
                                    <span x-text="adminTasksLoading ? '–û–±–Ω–æ–≤–ª—è–µ–º...' : '–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫'"></span>
                                </button>
                            </div>
                            <p x-show="adminTasksError" class="text-sm text-red-500 mb-4" x-text="adminTasksError"></p>
                            <div x-show="adminTasksLoading" class="flex items-center justify-center text-gray-500 py-6">
                                <i class="fas fa-spinner fa-spin mr-2"></i>
                                <span>–ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞–Ω–∏—è...</span>
                            </div>
                            <div x-show="!adminTasksLoading && !adminTasks.length" class="text-sm text-gray-500">
                                –ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ –≤—ã—à–µ, —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å –∏–º –∑–¥–µ—Å—å.
                            </div>
                            <div x-show="!adminTasksLoading && adminTasks.length" class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 text-sm">
                                    <thead class="bg-purple-50 text-gray-600 uppercase text-xs tracking-wide">
                                        <tr>
                                            <th class="px-4 py-3 text-left font-semibold">–ó–∞–¥–∞–Ω–∏–µ</th>
                                            <th class="px-4 py-3 text-center font-semibold">–°–ª–æ–∂–Ω–æ—Å—Ç—å</th>
                                            <th class="px-4 py-3 text-center font-semibold">–ù–∞–≥—Ä–∞–¥—ã</th>
                                            <th class="px-4 py-3 text-right font-semibold">–î–µ–π—Å—Ç–≤–∏—è</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-100">
                                        <template x-for="task in adminTasks" :key="`admin-task-${task.id}`">
                                            <tr class="hover:bg-purple-50/40">
                                                <td class="px-4 py-3">
                                                    <p class="font-semibold text-gray-800" x-text="task.title"></p>
                                                    <p class="text-xs text-gray-500" x-text="task.subject || '–û–±—â–∏–π —Ä–∞–∑–¥–µ–ª'"></p>
                                                </td>
                                                <td class="px-4 py-3 text-center">
                                                    <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-700">
                                                        <i class="fas fa-signal mr-1"></i>
                                                        <span x-text="'–£—Ä. ' + task.difficulty"></span>
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3 text-center">
                                                    <div class="flex flex-col items-center leading-tight">
                                                        <span class="text-sm font-semibold text-yellow-600" x-text="task.reward_coins + ' –º–æ–Ω–µ—Ç'"></span>
                                                        <span class="text-xs text-purple-600" x-text="task.reward_exp + ' XP'"></span>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3 text-right space-y-2 md:space-y-0 md:space-x-2 md:flex md:justify-end">
                                                    <button type="button"
                                                            @click="startAdminEdit(task)"
                                                            class="inline-flex items-center px-3 py-2 bg-white border border-purple-200 rounded-lg text-purple-600 font-semibold hover:bg-purple-50 transition">
                                                        <i class="fas fa-pen mr-2"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                                    </button>
                                                    <button type="button"
                                                            @click="deleteAdminTask(task.id)"
                                                            :disabled="adminDeletingTaskId === task.id"
                                                            class="inline-flex items-center px-3 py-2 bg-red-50 border border-red-200 rounded-lg text-red-600 font-semibold hover:bg-red-100 transition disabled:opacity-60 disabled:cursor-not-allowed">
                                                        <span x-show="adminDeletingTaskId !== task.id">
                                                            <i class="fas fa-trash mr-2"></i> –£–¥–∞–ª–∏—Ç—å
                                                        </span>
                                                        <span x-show="adminDeletingTaskId === task.id">
                                                            <i class="fas fa-spinner fa-spin mr-2"></i> –£–¥–∞–ª—è–µ–º...
                                                        </span>
                                                    </button>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div x-show="adminEditTaskId" x-cloak class="bg-white border border-purple-100 rounded-2xl p-6 shadow-sm">
                            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4 mb-6">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-900">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</h3>
                                    <p class="text-sm text-gray-500"
                                       x-text="(adminTasks.find(task => task.id === adminEditTaskId)?.title) || '–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ'"></p>
                                </div>
                                <button type="button" class="text-sm text-gray-500 hover:text-gray-700" @click="cancelAdminEdit()">
                                    <i class="fas fa-times mr-1"></i> –û—Ç–º–µ–Ω–∏—Ç—å
                                </button>
                            </div>
                            <form @submit.prevent="submitAdminEdit" class="space-y-4">
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                        <input type="text" x-model="adminEditForm.title" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                                        <select x-model.number="adminEditForm.difficulty" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                                            <option value="1">‚≠ê –õ–µ–≥–∫–æ</option>
                                            <option value="2">‚≠ê‚≠ê –°—Ä–µ–¥–Ω–µ</option>
                                            <option value="3">‚≠ê‚≠ê‚≠ê –°–ª–æ–∂–Ω–æ</option>
                                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê –û—á–µ–Ω—å —Å–ª–æ–∂–Ω–æ</option>
                                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê –≠–∫—Å–ø–µ—Ä—Ç</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                                    <textarea x-model="adminEditForm.description" rows="4" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none" placeholder="–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É"></textarea>
                                </div>
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">–ù–∞–≥—Ä–∞–¥–∞ (–º–æ–Ω–µ—Ç—ã)</label>
                                        <input type="number" min="0" x-model.number="adminEditForm.reward_coins" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">–ù–∞–≥—Ä–∞–¥–∞ (–æ–ø—ã—Ç)</label>
                                        <input type="number" min="0" x-model.number="adminEditForm.reward_exp" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">HTML-—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                                    <textarea x-model="adminEditForm.content_html" rows="4" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Å—ã–ª–∫—É/HTML"></textarea>
                                </div>
                                <div class="flex justify-end gap-3">
                                    <button type="button" class="px-4 py-2 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50" @click="cancelAdminEdit()">–û—Ç–º–µ–Ω–∞</button>
                                    <button type="submit"
                                            :disabled="adminEditing"
                                            :class="adminEditing ? 'bg-gray-400 cursor-not-allowed' : 'bg-purple-600 hover:bg-purple-700'"
                                            class="px-6 py-2 rounded-lg text-white font-semibold">
                                        <span x-show="!adminEditing"><i class="fas fa-save mr-2"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</span>
                                        <span x-show="adminEditing"><i class="fas fa-spinner fa-spin mr-2"></i> –°–æ—Ö—Ä–∞–Ω—è–µ–º...</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ -->
    <div x-show="selectedTask" @click.away="selectedTask = null"
         x-transition
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" @click.stop>
            <div class="p-6">
                <div class="flex justify-between items-start mb-4 gap-4">
                    <div class="space-y-2">
                        <h2 class="text-2xl font-bold text-gray-900" x-text="selectedTask?.title"></h2>
                        <div class="flex flex-wrap gap-2">
                            <span x-show="selectedTask?.subject"
                                  class="inline-block px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-semibold"
                                  x-text="selectedTask?.subject"></span>
                            <span x-show="selectedTask?.isAssigned"
                                  class="inline-flex items-center px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold uppercase tracking-wide">
                                <i class="fas fa-user-check mr-1"></i> –ù–∞–∑–Ω–∞—á–µ–Ω–æ –≤–∞–º
                            </span>
                        </div>
                    </div>
                    <button @click="selectedTask = null" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div class="mb-6 space-y-6">
                    <p class="text-gray-700 whitespace-pre-wrap" x-text="selectedTask?.description"></p>
                    <div x-show="selectedTask?.content_html">
                        <button type="button"
                                @click="openTaskHtmlInNewTab()"
                                class="w-full flex items-center justify-center gap-2 px-4 py-3 text-base font-semibold rounded-xl bg-purple-600 text-white hover:bg-purple-700 transition">
                            <i class="fas fa-external-link-alt"></i>
                            –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ—à–µ–Ω–∏—é –∑–∞–¥–∞—á–∏
                        </button>
                    </div>
                </div>

                <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center mb-4" x-show="!isAdmin()">
                    <input type="file" id="photoInput" accept="image/*" class="hidden" @change="handleFileSelect">
                    <label for="photoInput" class="cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                        <p class="text-lg font-semibold mb-2">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –≤–∞—à–µ–π —Ä–∞–±–æ—Ç—ã</p>
                        <p class="text-sm text-gray-500">JPG, PNG –¥–æ 10 –ú–ë</p>
                    </label>

                    <div x-show="selectedFile" class="mt-4">
                        <img :src="previewUrl" class="max-w-full h-64 mx-auto rounded-lg">
                        <p class="mt-2 text-sm text-gray-600" x-text="selectedFile?.name"></p>
                    </div>
                </div>

                <div class="flex justify-end space-x-4" x-show="!isAdmin()">
                    <button @click="selectedTask = null; selectedFile = null"
                            class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button @click="submitTask()"
                            :disabled="!selectedFile || submitting"
                            :class="selectedFile && !submitting ? 'gradient-bg hover:opacity-90' : 'bg-gray-300 cursor-not-allowed'"
                            class="px-6 py-2 text-white rounded-lg font-semibold">
                        <span x-show="!submitting">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</span>
                        <span x-show="submitting">
                            <i class="fas fa-spinner fa-spin mr-2"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div class="fixed bottom-4 right-4 z-50 space-y-2" id="notifications">
        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>

    <script>
        const DEFAULT_API_BASE = '/api';
        const normalizeApiBase = (base) => {
            if (typeof base !== 'string') {
                return DEFAULT_API_BASE;
            }
            const trimmed = base.trim();
            return trimmed.replace(/\/+$/, '') || DEFAULT_API_BASE;
        };

        const readInitialApiBase = () => {
            let queryBase = '';
            try {
                const params = new URLSearchParams(window.location.search);
                queryBase = params.get('apiBase') || params.get('api') || '';
            } catch (error) {
                console.warn('Unable to parse API base from query params', error);
            }

            const globalBase = typeof window !== 'undefined' && (window.API_BASE || window.__API_BASE__)
                ? window.API_BASE || window.__API_BASE__
                : '';
            const storedBase = (() => {
                try {
                    return localStorage.getItem('api_base');
                } catch {
                    return '';
                }
            })();

            const candidate = queryBase || globalBase || storedBase || DEFAULT_API_BASE;
            const normalized = normalizeApiBase(candidate);

            if (queryBase && normalized) {
                try {
                    localStorage.setItem('api_base', normalized);
                } catch {
                    // Ignore storage failures (e.g. private mode)
                }
            }

            return normalized;
        };
        const API_BASE = readInitialApiBase();
        const ensureTrailingSlash = (url) => url.endsWith('/') ? url : `${url}/`;
        const resolveUrl = (url) => {
            try {
                return new URL(url, window.location.origin).toString();
            } catch (error) {
                console.warn('Failed to resolve URL, returning as-is', { url, error });
                return url;
            }
        };
        const normalizeTaskCollection = (payload, context = 'tasks') => {
            if (!payload) {
                return { items: [], total: 0 };
            }

            if (Array.isArray(payload)) {
                return { items: payload, total: payload.length };
            }

            if (Array.isArray(payload.items)) {
                const total = Number(payload.total);
                return {
                    items: payload.items,
                    total: Number.isFinite(total) ? total : payload.items.length
                };
            }

            if (Array.isArray(payload.data)) {
                const total = Number(payload.total);
                return {
                    items: payload.data,
                    total: Number.isFinite(total) ? total : payload.data.length
                };
            }

            if (typeof payload === 'object') {
                console.warn(`Unexpected ${context} payload shape`, payload);
            }

            const fallbackTotal = Number(payload?.total ?? 0);
            return { items: [], total: Number.isFinite(fallbackTotal) ? fallbackTotal : 0 };
        };

        const createDefaultUser = () => ({
            id: null,
            role: 'guest',
            coins: 0,
            level: 1,
            experience: 0,
            tasks_completed: 0,
            average_score: 0,
            username: '–ì–æ—Å—Ç—å'
        });
        async function parseJsonSafe(response) {
            const contentType = response.headers.get('content-type') || '';
            if (contentType.includes('application/json')) {
                return await response.json();
            }

            const fallbackText = await response.text();
            try {
                return JSON.parse(fallbackText);
            } catch {
                return fallbackText ? { detail: fallbackText.trim() } : {};
            }
        }

        async function fetchJson(url, options = {}) {
            const {
                _retryAlternatePath = false,
                _retryTrailingSlash = false,
                ...cleanOptions
            } = options;
            const method = (cleanOptions.method || 'GET').toUpperCase();
            const headers = {
                Accept: 'application/json',
                ...(cleanOptions.headers || {})
            };
            if (method !== 'GET' && method !== 'HEAD' && !(cleanOptions.body instanceof FormData)) {
                headers['Content-Type'] = 'application/json';
            }
            const authToken = localStorage.getItem('access_token');
            if (authToken && !('Authorization' in headers)) {
                headers.Authorization = `Bearer ${authToken}`;
            }
            const requestInit = { ...cleanOptions, method, headers };

            if ((method === 'GET' || method === 'HEAD') && 'body' in requestInit) {
                delete requestInit.body;
            }

            if (
                requestInit.body != null &&
                !(requestInit.body instanceof FormData) &&
                method !== 'GET' &&
                method !== 'HEAD' &&
                typeof requestInit.body !== 'string'
            ) {
                requestInit.body = JSON.stringify(requestInit.body);
            }
            let response;
            try {
                response = await fetch(url, requestInit);
            } catch (networkError) {
                const err = new Error('Network request failed');
                err.status = 0;
                err.cause = networkError;
                err.payload = { detail: networkError?.message || 'Network request failed' };
                throw err;
            }

            if (response.status === 405 && method === 'GET' && !_retryAlternatePath) {
                if (url.endsWith('/')) {
                    const withoutSlash = url.replace(/\/+$/, '');
                    if (withoutSlash) {
                        return fetchJson(withoutSlash, { ...cleanOptions, _retryAlternatePath: true });
                    }
                } else {
                    return fetchJson(`${url}/`, { ...cleanOptions, _retryAlternatePath: true });
                }
            }
            const payload = await parseJsonSafe(response);

            if (!response.ok) {
                const err = new Error(`HTTP ${response.status}${response.statusText ? ` ${response.statusText}` : ''}`);
                err.status = response.status;
                err.payload = payload;
                throw err;
            }

            if (response.status === 204) {
                return null;
            }

            return payload;
        }

        function app() {
            return {
                // API URL
                apiUrl: API_BASE,

                // –°–æ—Å—Ç–æ—è–Ω–∏–µ
                user: createDefaultUser(),
                isAuthenticated: false,
                token: localStorage.getItem('access_token'),
                authMode: 'login',
                authData: {
                    username: '',
                    email: '',
                    password: ''
                },
                authError: '',

                // UI
                activeTab: 'tasks',
                selectedTask: null,
                taskHtmlExpanded: false,
                selectedFile: null,
                previewUrl: null,
                submitting: false,
                htmlResultProcessing: false,
                htmlResultListenerBound: false,
                htmlResultHandler: null,

                // –î–∞–Ω–Ω—ã–µ
                tasks: [],
                filteredTasks: [],
                submissions: [],
                shopItems: [],
                leaderboard: [],
                assignedTaskIds: [],
                adminTaskForm: {
                    title: '',
                    subject: '',
                    task_type: 'math',
                    difficulty: 1,
                    reward_coins: 10,
                    reward_exp: 50,
                    min_level: 1,
                    max_attempts: 3,
                    time_limit: null,
                    description: '',
                    content_html: ''
                },
                adminTaskAssignees: [],
                adminSearchQueryCreate: '',
                adminSearchResultsCreate: [],
                adminSearchLoadingCreate: false,
                adminAssignTaskId: '',
                adminAssignAssignees: [],
                adminSearchQueryAssign: '',
                adminSearchResultsAssign: [],
                adminSearchLoadingAssign: false,
                adminCreating: false,
                adminAssigning: false,
                adminTasks: [],
                adminTasksTotal: 0,
                adminTasksLoading: false,
                adminTasksError: '',
                adminEditTaskId: null,
                adminEditForm: {
                    title: '',
                    description: '',
                    difficulty: 1,
                    reward_coins: 0,
                    reward_exp: 0,
                    content_html: ''
                },
                adminEditing: false,
                adminDeletingTaskId: null,

                // –§–∏–ª—å—Ç—Ä—ã
                filters: {
                    subject: '',
                    difficulty: ''
                },

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
                async init() {
                    this.setupHtmlResultListener();
                    if (this.token) {
                        await this.loadUserData();
                    } else {
                        await this.loadTasks();
                    }
                },
                setupHtmlResultListener() {
                    if (this.htmlResultListenerBound) {
                        return;
                    }

                    const handler = (event) => {
                        if (!event || typeof event.data !== 'object') {
                            return;
                        }

                        const sameOrigin = !event.origin || event.origin === 'null' || event.origin === window.location.origin;
                        if (!sameOrigin) {
                            return;
                        }

                        const type = event.data?.type || event.data?.eventType;
                        const source = event.data?.source || event.data?.origin;
                        const payload = event.data?.payload || event.data?.result || event.data;
                        const hasKnownSignature = type === 'html_task_result' || source === 'edu-platform-html-task';
                        const hasTaskId = Boolean(payload && (payload.taskId !== undefined || payload.task_id !== undefined));

                        if (!hasKnownSignature && !hasTaskId) {
                            return;
                        }

                        if (payload) {
                            this.handleHtmlTaskResult(payload);
                        }
                    };

                    window.addEventListener('message', handler);
                    this.htmlResultHandler = handler;
                    this.htmlResultListenerBound = true;
                },

                async handleHtmlTaskResult(rawPayload) {
                    const payload = rawPayload || {};
                    const taskIdValue = payload.taskId ?? payload.task_id;
                    const taskId = Number(taskIdValue);

                    if (!Number.isFinite(taskId)) {
                        this.showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è –∑–∞—á–µ—Ç–∞ HTML-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞', 'error');
                        return;
                    }

                    if (!this.token) {
                        this.showNotification('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∑–∞—á–µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–¥–∞–Ω–∏—è', 'error');
                        return;
                    }

                    if (this.htmlResultProcessing) {
                        return;
                    }

                    const safeClone = (value) => {
                        if (!value || typeof value !== 'object') {
                            return undefined;
                        }
                        try {
                            return JSON.parse(JSON.stringify(value));
                        } catch (error) {
                            console.warn('Failed to clone HTML task details', error);
                            return undefined;
                        }
                    };

                    const scoreCandidate = Number(payload.score ?? payload.points ?? payload.result ?? 0);
                    const scoreValue = Number.isFinite(scoreCandidate) ? scoreCandidate : 0;

                    const rawMaxScore = Number(payload.maxScore ?? payload.max_score ?? payload.total ?? payload.totalPoints);
                    const maxScoreValue = Number.isFinite(rawMaxScore) && rawMaxScore > 0 ? rawMaxScore : null;

                    const rawTime = Number(payload.timeSpent ?? payload.time_spent ?? payload.duration ?? payload.elapsedSeconds);
                    const timeSpent = Number.isFinite(rawTime) && rawTime >= 0 ? Math.round(rawTime) : null;

                    const detailsPayload = {};
                    [
                        ['details', 'details'],
                        ['answers', 'answers'],
                        ['meta', 'meta'],
                        ['breakdown', 'breakdown'],
                        ['stats', 'stats']
                    ].forEach(([key, target]) => {
                        const cloned = safeClone(payload[key]);
                        if (cloned !== undefined) {
                            detailsPayload[target] = cloned;
                        }
                    });

                    const detailsToSend = Object.keys(detailsPayload).length ? detailsPayload : null;
                    const resultText = payload.summary || payload.message || payload.resultText || payload.feedback || null;

                    this.htmlResultProcessing = true;

                    try {
                        const response = await fetch(`${this.apiUrl}/submissions/html-result`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${this.token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                task_id: taskId,
                                score: scoreValue,
                                max_score: maxScoreValue,
                                time_spent: timeSpent,
                                result_text: resultText,
                                details: detailsToSend
                            })
                        });

                        const data = await parseJsonSafe(response);

                        if (response.ok) {
                            const coins = Number(data?.coins_earned ?? 0);
                            const exp = Number(data?.exp_earned ?? 0);
                            const message = data?.message || '–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω';
                            this.showNotification(`${message} (+${coins} –º–æ–Ω–µ—Ç, +${exp} XP)`, 'success');
                            await this.loadUserData();
                            await this.loadSubmissions();
                        } else {
                            const errorMessage = data?.detail || data?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç HTML-–∑–∞–¥–∞–Ω–∏—è';
                            this.showNotification(errorMessage, 'error');
                        }
                    } catch (error) {
                        console.error('Error saving HTML task result:', error);
                        this.showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ HTML-–∑–∞–¥–∞–Ω–∏—è', 'error');
                    } finally {
                        this.htmlResultProcessing = false;
                    }
                },

                // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
                async login() {
                    this.authError = '';

                    const formData = new FormData();
                    formData.append('username', this.authData.username);
                    formData.append('password', this.authData.password);

                    try {
                        const response = await fetch(`${this.apiUrl}/auth/login`, {
                            method: 'POST',
                            body: formData
                        });

                        const data = await parseJsonSafe(response);

                        if (response.ok) {
                            this.token = data.access_token;
                            localStorage.setItem('access_token', this.token);
                            await this.loadUserData();
                            this.showNotification('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                        } else {
                            // –ë–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
                            if (response.status === 500) {
                                this.authError = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –í–æ–∑–º–æ–∂–Ω–æ, –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: python reset_db.py';
                            } else if (response.status === 401) {
                                this.authError = '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                            } else if (response.status === 423) {
                                this.authError = '–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω';
                            } else {
                                this.authError = data.detail || `–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ (${response.status})`;
                            }
                            console.error('Login error:', { status: response.status, data });
                        }
                    } catch (error) {
                        console.error('Network error:', error);
                        const resolvedApiUrl = this.apiUrl.startsWith('http')
                            ? this.apiUrl
                            : `${window.location.origin}${this.apiUrl}`;
                        this.authError = `–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ ${resolvedApiUrl}`;
                    }
                },

                async register() {
                    this.authError = '';

                    try {
                        const response = await fetch(`${this.apiUrl}/auth/register`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                username: this.authData.username,
                                email: this.authData.email,
                                password: this.authData.password
                            })
                        });

                        const data = await parseJsonSafe(response);

                        if (response.ok) {
                            this.showNotification('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ', 'success');
                            this.authMode = 'login';
                            this.authData.email = '';
                            this.authData.password = '';
                        } else {
                            this.authError = data.detail || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
                        }
                    } catch (error) {
                        this.authError = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
                    }
                },

                async demoLogin() {
                    this.authData.username = 'student1';
                    this.authData.password = 'student123';
                    await this.login();
                },

                logout(showMessage = true) {
                    this.token = null;
                    this.user = createDefaultUser();
                    this.isAuthenticated = false;
                    this.tasks = [];
                    this.filteredTasks = [];
                    this.assignedTaskIds = [];
                    this.adminTaskAssignees = [];
                    this.adminAssignAssignees = [];
                    this.adminAssignTaskId = '';
                    this.adminSearchQueryCreate = '';
                    this.adminSearchResultsCreate = [];
                    this.adminSearchQueryAssign = '';
                    this.adminSearchResultsAssign = [];
                    this.adminCreating = false;
                    this.adminAssigning = false;
                    if (typeof this.resetAdminTaskForm === 'function') {
                        this.resetAdminTaskForm();
                    }
                    if (typeof this.resetAdminEditForm === 'function') {
                        this.resetAdminEditForm();
                    }
                    this.adminEditTaskId = null;
                    this.adminTasks = [];
                    this.adminTasksTotal = 0;
                    this.adminTasksLoading = false;
                    this.adminTasksError = '';
                    this.activeTab = 'tasks';
                    localStorage.removeItem('access_token');
                    if (showMessage) {
                        this.showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'info');
                    }
                },

                isAdmin() {
                    return this.isAuthenticated && this.user?.role === 'admin';
                },

                // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                async loadUserData() {
                    if (!this.token) {
                        this.user = createDefaultUser();
                        this.isAuthenticated = false;
                        await this.loadTasks();
                        return;
                    }

                    try {
                        const userData = await fetchJson(`${this.apiUrl}/auth/me`, {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });

                        this.user = Object.assign(createDefaultUser(), userData || {});
                        this.isAuthenticated = Boolean(this.user?.id);

                        if (this.isAdmin()) {
                            this.activeTab = 'admin';
                        } else {
                            this.activeTab = 'tasks';
                        }
                        await this.loadTasks();
                    } catch (error) {
                        console.error('Error loading user data:', error);
                        if (error.status === 401) {
                            this.showNotification('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', 'error');
                            this.authMode = 'login';
                        }
                        this.logout(false);
                        await this.loadTasks();
                    }
                },

                async loadTasks() {
                    const isAdminUser = this.isAdmin();

                    if (isAdminUser) {
                        this.adminTasksLoading = true;
                        this.adminTasksError = '';
                    } else {
                        this.adminTasks = [];
                        this.adminTasksTotal = 0;
                        this.adminTasksLoading = false;
                    }

                    try {
                        let adminTasksPayload = null;

                        if (isAdminUser && this.token) {
                            try {
                                const adminTasksUrl = `${this.apiUrl}/admin/tasks`;
                                adminTasksPayload = await fetchJson(adminTasksUrl, {
                                    method: 'GET',
                                    headers: { 'Authorization': `Bearer ${this.token}` }
                                });
                            } catch (error) {
                                if (error.status === 401 || error.status === 403) {
                                    this.showNotification('–°–µ—Å—Å–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.', 'error');
                                    this.logout();
                                    return;
                                }
                                const details = error.payload?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è';
                                this.adminTasksError = details;
                                console.error('Failed to load admin tasks:', error.payload || error);
                            }
                        }

                        const normalizedAdminTasks = normalizeTaskCollection(adminTasksPayload, 'admin tasks');

                        if (isAdminUser) {
                            this.adminTasks = normalizedAdminTasks.items;
                            this.adminTasksTotal = normalizedAdminTasks.total;
                        }

                        let baseTasks = normalizedAdminTasks;

                        if (!baseTasks.items.length) {
                            try {
                                const publicPayload = await fetchJson(`${this.apiUrl}/tasks`);
                                baseTasks = normalizeTaskCollection(publicPayload, 'public tasks');
                            } catch (error) {
                                console.error('Failed to load public tasks:', error.payload || error);
                                baseTasks = { items: [], total: 0 };
                            }
                        }

                        let assignedTasks = { items: [], total: 0 };
                        if (this.token && this.isAuthenticated) {
                            try {
                                const assignedPayload = await fetchJson(`${this.apiUrl}/tasks/assigned`, {
                                    headers: { 'Authorization': `Bearer ${this.token}` }
                                });
                                assignedTasks = normalizeTaskCollection(assignedPayload, 'assigned tasks');
                            } catch (error) {
                                if (error.status === 401 || error.status === 403) {
                                    this.showNotification('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', 'error');
                                    this.logout();
                                    return;
                                }
                                console.error('Failed to load assigned tasks:', error.payload || error);
                            }
                        }

                        const assignedItems = Array.isArray(assignedTasks.items) ? assignedTasks.items : [];
                        const generalItems = Array.isArray(baseTasks.items) ? baseTasks.items : [];

                        const assignedIds = new Set(assignedItems.map(task => task.id));
                        const combined = [...assignedItems, ...generalItems];
                        const unique = [];
                        const seen = new Set();

                        for (const task of combined) {
                            if (!task || seen.has(task.id)) continue;
                            seen.add(task.id);
                            unique.push({ ...task, isAssigned: assignedIds.has(task.id) });
                        }

                        this.tasks = unique;
                        this.assignedTaskIds = Array.from(assignedIds);
                        this.filterTasks();
                    } catch (error) {
                        console.error('Error loading tasks:', error);
                        this.showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è', 'error');
                    } finally {
                        if (isAdminUser) {
                            this.adminTasksLoading = false;
                        }
                    }
                },

                filterTasks() {
                    this.filteredTasks = this.tasks.filter(task => {
                        if (this.filters.subject && task.subject !== this.filters.subject) return false;
                        if (this.filters.difficulty && task.difficulty != this.filters.difficulty) return false;
                        return true;
                    });
                },

                async loadSubmissions() {
                    if (!this.token) {
                        this.submissions = [];
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/submissions/my-submissions`, {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });

                        if (response.status === 401) {
                            this.logout();
                            this.authMode = 'login';
                            this.showNotification('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', 'error');
                            return;
                        }

                        this.submissions = await parseJsonSafe(response);
                    } catch (error) {
                        console.error('Error loading submissions:', error);
                    }
                },

                async loadShop() {
                    try {
                        const response = await fetch(`${this.apiUrl}/shop/items`);
                        this.shopItems = await response.json();
                    } catch (error) {
                        console.error('Error loading shop:', error);
                    }
                },

                async loadLeaderboard() {
                    try {
                        const response = await fetch(`${this.apiUrl}/coins/leaderboard`);
                        this.leaderboard = await response.json();
                    } catch (error) {
                        console.error('Error loading leaderboard:', error);
                    }
                },

                // –†–∞–±–æ—Ç–∞ —Å –∑–∞–¥–∞–Ω–∏—è–º–∏
                selectTask(task) {
                    this.selectedTask = { ...task };
                    this.taskHtmlExpanded = false;
                    this.selectedFile = null;
                    this.previewUrl = null;
                },

                openTaskHtmlInNewTab() {
                    const content = this.selectedTask?.content_html;
                    if (!content) return;

                    const rawTitle = this.selectedTask?.title || '–ó–∞–¥–∞–Ω–∏–µ';
                    const title = rawTitle.replace(/[<>]/g, '');
                    const htmlDocument = `<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><title>${title}</title></head><body>${content}</body></html>`;

                    const blob = new Blob([htmlDocument], { type: 'text/html;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    window.open(url, '_blank', 'noopener');
                    setTimeout(() => URL.revokeObjectURL(url), 60000);
                },

                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.selectedFile = file;

                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.previewUrl = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                },

                async submitTask() {
                    if (!this.selectedFile || this.submitting) return;

                    if (!this.token || typeof this.token !== 'string' || !this.token.includes('.')) {
                        this.showNotification('–°–µ—Å—Å–∏—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.', 'error');
                        this.logout();
                        this.authMode = 'login';
                        return;
                    }

                    this.submitting = true;

                    const formData = new FormData();
                    formData.append('task_id', this.selectedTask.id);
                    formData.append('photo', this.selectedFile);

                    try {
                        const response = await fetch(`${this.apiUrl}/submissions/submit`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${this.token}` },
                            body: formData
                        });

                        const data = await parseJsonSafe(response);

                        if (response.ok) {
                            this.showNotification('–†–∞–±–æ—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É!', 'success');
                            this.selectedTask = null;
                            this.selectedFile = null;

                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è
                            setTimeout(() => this.checkSubmissionStatus(data.id), 5000);
                        } else if (response.status === 401) {
                            this.showNotification('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', 'error');
                            this.logout();
                            this.authMode = 'login';
                        } else {
                            this.showNotification(data.detail || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
                        }
                    } catch (error) {
                        this.showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
                    } finally {
                        this.submitting = false;
                    }
                },

                async checkSubmissionStatus(submissionId) {
                    try {
                        const response = await fetch(`${this.apiUrl}/submissions/${submissionId}/status`, {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });

                        const data = await response.json();

                        if (data.status === 'checked') {
                            this.showNotification(`–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –û—Ü–µ–Ω–∫–∞: ${data.score}/100`, 'success');
                            await this.loadUserData();
                            await this.loadSubmissions();
                        } else if (data.status === 'processing') {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                            setTimeout(() => this.checkSubmissionStatus(submissionId), 5000);
                        }
                    } catch (error) {
                        console.error('Error checking status:', error);
                    }
                },

                async purchaseItem(item) {
                    const availableCoins = this.user?.coins ?? 0;

                    if (availableCoins < item.price) {
                        this.showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/shop/purchase`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${this.token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ item_id: item.id })
                        });

                        if (response.ok) {
                            this.showNotification(`–í—ã –∫—É–ø–∏–ª–∏ "${item.name}"!`, 'success');
                            await this.loadUserData();
                        } else {
                            const data = await response.json();
                            this.showNotification(data.detail || '–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏', 'error');
                        }
                    } catch (error) {
                        this.showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
                    }
                },

                async searchUsers(context = 'create') {
                    if (!this.isAdmin() || !this.token) {
                        this.showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
                        return;
                    }

                    const query = context === 'assign' ? this.adminSearchQueryAssign : this.adminSearchQueryCreate;
                    const trimmed = (query || '').trim();

                    if (!trimmed) {
                        this.showNotification('–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'info');
                        return;
                    }

                    const loadingKey = context === 'assign' ? 'adminSearchLoadingAssign' : 'adminSearchLoadingCreate';
                    const resultsKey = context === 'assign' ? 'adminSearchResultsAssign' : 'adminSearchResultsCreate';

                    this[loadingKey] = true;
                    try {
                        const response = await fetch(`${this.apiUrl}/admin/users/search?q=${encodeURIComponent(trimmed)}`, {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });

                        const data = await parseJsonSafe(response);

                        if (response.ok) {
                            this[resultsKey] = Array.isArray(data) ? data : [];
                            if (!this[resultsKey].length) {
                                this.showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'info');
                            }
                        } else {
                            this.showNotification(data.detail || '–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
                        }
                    } catch (error) {
                        console.error('Error searching users:', error);
                        this.showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∏—Å–∫', 'error');
                    } finally {
                        this[loadingKey] = false;
                    }
                },

                addAssignee(user, context = 'create') {
                    if (!user) return;

                    const targetList = context === 'assign' ? this.adminAssignAssignees : this.adminTaskAssignees;
                    if (!targetList.find(candidate => candidate.id === user.id)) {
                        targetList.push({ ...user });
                    }
                },

                removeAssignee(userId, context = 'create') {
                    if (context === 'assign') {
                        this.adminAssignAssignees = this.adminAssignAssignees.filter(user => user.id !== userId);
                    } else {
                        this.adminTaskAssignees = this.adminTaskAssignees.filter(user => user.id !== userId);
                    }
                },

                resetAdminTaskForm() {
                    this.adminTaskForm = {
                        title: '',
                        subject: '',
                        task_type: 'math',
                        difficulty: 1,
                        reward_coins: 10,
                        reward_exp: 50,
                        min_level: 1,
                        max_attempts: 3,
                        time_limit: null,
                        description: '',
                        content_html: ''
                    };
                    this.adminTaskAssignees = [];
                    this.adminSearchQueryCreate = '';
                    this.adminSearchResultsCreate = [];
                },

                resetAdminEditForm() {
                    this.adminEditForm = {
                        title: '',
                        description: '',
                        difficulty: 1,
                        reward_coins: 0,
                        reward_exp: 0,
                        content_html: ''
                    };
                },

                startAdminEdit(task) {
                    if (!task) return;

                    this.adminEditTaskId = task.id;
                    this.adminEditForm = {
                        title: task.title || '',
                        description: task.description || '',
                        difficulty: Number(task.difficulty) || 1,
                        reward_coins: Number(task.reward_coins ?? 0) || 0,
                        reward_exp: Number(task.reward_exp ?? 0) || 0,
                        content_html: task.content_html || ''
                    };
                    this.activeTab = 'admin';
                },

                cancelAdminEdit() {
                    this.adminEditTaskId = null;
                    this.resetAdminEditForm();
                },

                async submitAdminEdit() {
                    if (!this.isAdmin() || !this.token || !this.adminEditTaskId) {
                        this.showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
                        return;
                    }

                    const title = (this.adminEditForm.title || '').trim();
                    const description = (this.adminEditForm.description || '').trim();

                    if (title.length < 3 || description.length < 10) {
                        this.showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ (–º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤)', 'error');
                        return;
                    }

                    const payload = {
                        title,
                        description,
                        difficulty: Math.max(1, Math.min(5, Number(this.adminEditForm.difficulty) || 1)),
                        reward_coins: Math.max(0, Number(this.adminEditForm.reward_coins) || 0),
                        reward_exp: Math.max(0, Number(this.adminEditForm.reward_exp) || 0),
                        content_html: (this.adminEditForm.content_html || '').trim() || null
                    };

                    this.adminEditing = true;

                    try {
                        await fetchJson(`${this.apiUrl}/admin/tasks/${this.adminEditTaskId}`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: payload
                        });

                        this.showNotification('–ó–∞–¥–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                        this.cancelAdminEdit();
                        await this.loadTasks();
                    } catch (error) {
                        if (error.status === 401 || error.status === 403) {
                            this.showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è', 'error');
                            this.logout();
                        } else {
                            const details = error.payload?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ';
                            this.showNotification(details, 'error');
                            console.error('Error updating task:', error.payload || error);
                        }
                    } finally {
                        this.adminEditing = false;
                    }
                },

                async deleteAdminTask(taskId) {
                    if (!this.isAdmin() || !this.token) {
                        this.showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è', 'error');
                        return;
                    }

                    const normalizedId = Number(taskId);
                    if (!normalizedId) {
                        this.showNotification('–ù–µ –≤—ã–±—Ä–∞–Ω–æ –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'error');
                        return;
                    }

                    const confirmed = window.confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.');
                    if (!confirmed) {
                        return;
                    }

                    this.adminDeletingTaskId = normalizedId;

                    try {
                        await fetchJson(`${this.apiUrl}/admin/tasks/${normalizedId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            }
                        });

                        this.showNotification('–ó–∞–¥–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
                        if (this.adminEditTaskId === normalizedId) {
                            this.cancelAdminEdit();
                        }
                        await this.loadTasks();
                    } catch (error) {
                        if (error.status === 401 || error.status === 403) {
                            this.showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è', 'error');
                            this.logout();
                        } else {
                            const details = error.payload?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ';
                            this.showNotification(details, 'error');
                            console.error('Error deleting task:', error.payload || error);
                        }
                    } finally {
                        this.adminDeletingTaskId = null;
                    }
                },


                async createAdminTask() {
                    if (!this.isAdmin() || !this.token) {
                        this.showNotification('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è', 'error');
                        return;
                    }

                    const title = (this.adminTaskForm.title || '').trim();
                    const description = (this.adminTaskForm.description || '').trim();

                    if (!title || description.length < 10) {
                        this.showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è (–º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤)', 'error');
                        return;
                    }

                    const timeLimitValue = Number(this.adminTaskForm.time_limit);
                    const timeLimit = Number.isFinite(timeLimitValue) && timeLimitValue > 0 ? timeLimitValue : null;
                    const contentHtml = (this.adminTaskForm.content_html || '').trim();

                    this.adminCreating = true;

                    const payload = {
                        title,
                        description,
                        subject: (this.adminTaskForm.subject || '').trim() || null,
                        task_type: this.adminTaskForm.task_type,
                        difficulty: Number(this.adminTaskForm.difficulty) || 1,
                        reward_coins: Math.max(0, Number(this.adminTaskForm.reward_coins) || 0),
                        reward_exp: Math.max(0, Number(this.adminTaskForm.reward_exp) || 0),
                        min_level: Math.max(1, Number(this.adminTaskForm.min_level) || 1),
                        max_attempts: Math.max(1, Number(this.adminTaskForm.max_attempts) || 1),
                        time_limit: timeLimit,
                        content_html: contentHtml || null,
                        assigned_user_ids: this.adminTaskAssignees.map(user => user.id)
                    };

                    try {
                        await fetchJson(`${this.apiUrl}/admin/tasks`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: payload
                        });

                        this.showNotification('–ó–∞–¥–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ', 'success');
                        this.resetAdminTaskForm();
                        await this.loadTasks();
                    } catch (error) {
                        if (error.status === 401 || error.status === 403) {
                            this.showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è', 'error');
                            this.logout();
                        } else {
                            const details = error.payload?.detail || error.payload?.error?.message;
                            this.showNotification(details || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ', 'error');
                            console.error('Error creating task:', error.payload || error);
                        }
                    } finally {
                        this.adminCreating = false;
                    }
                },

                async assignExistingTask() {
                    if (!this.isAdmin() || !this.token) {
                        this.showNotification('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –Ω–∞–∑–Ω–∞—á–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è', 'error');
                        return;
                    }

                    const taskId = Number(this.adminAssignTaskId);
                    if (!taskId) {
                        this.showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è', 'error');
                        return;
                    }

                    if (!this.adminAssignAssignees.length) {
                        this.showNotification('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —É—á–µ–Ω–∏–∫–∞', 'error');
                        return;
                    }

                    this.adminAssigning = true;

                    const payload = {
                        user_ids: this.adminAssignAssignees.map(user => user.id)
                    };

                    try {
                        await fetchJson(`${this.apiUrl}/admin/tasks/${taskId}/assign`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: payload
                        });

                        this.showNotification('–ó–∞–¥–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —É—á–µ–Ω–∏–∫–∞–º', 'success');
                        this.adminAssignTaskId = '';
                        this.adminAssignAssignees = [];
                        this.adminSearchQueryAssign = '';
                        this.adminSearchResultsAssign = [];
                        await this.loadTasks();
                    } catch (error) {
                        if (error.status === 401 || error.status === 403) {
                            this.showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è', 'error');
                            this.logout();
                        } else {
                            const details = error.payload?.detail || error.payload?.error?.message;
                            this.showNotification(details || '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ', 'error');
                            console.error('Error assigning task:', error.payload || error);
                        }
                    } finally {
                        this.adminAssigning = false;
                    }
                },

                // –£—Ç–∏–ª–∏—Ç—ã
                showNotification(message, type = 'info') {
                    const notification = document.createElement('div');
                    notification.className = `p-4 rounded-lg shadow-lg fade-in ${
                        type === 'success' ? 'bg-green-500' :
                        type === 'error' ? 'bg-red-500' :
                        'bg-blue-500'
                    } text-white`;
                    notification.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-${
                                type === 'success' ? 'check-circle' :
                                type === 'error' ? 'exclamation-circle' :
                                'info-circle'
                            } mr-3"></i>
                            <span>${message}</span>
                        </div>
                    `;

                    document.getElementById('notifications').appendChild(notification);

                    setTimeout(() => {
                        notification.style.opacity = '0';
                        setTimeout(() => notification.remove(), 300);
                    }, 3000);
                },

                getStatusText(status) {
                    const statusMap = {
                        'pending': '‚è≥ –û–∂–∏–¥–∞–µ—Ç',
                        'processing': 'üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è',
                        'checked': '‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ',
                        'failed': '‚ùå –û—à–∏–±–∫–∞'
                    };
                    return statusMap[status] || status;
                },

                getItemIcon(item) {
                    const icons = {
                        'avatar': 'üë§',
                        'badge': 'üèÖ',
                        'theme': 'üé®',
                        'power_up': '‚ö°',
                        'hint': 'üí°'
                    };
                    return icons[item.item_type] || 'üì¶';
                },

                getRankIcon(rank) {
                    if (rank === 1) return 'ü•á';
                    if (rank === 2) return 'ü•à';
                    if (rank === 3) return 'ü•â';
                    return `#${rank}`;
                },

                formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleString('ru-RU');
                },

                showImage(url) {
                    window.open(url, '_blank');
                }
            }
        }
    </script>

</body>
</html>